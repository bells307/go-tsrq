# Go Timestamp Round Queue

Самоочищающаяся очередь элементов, основанная на Redis, элементы которой выдаются в порядке давности последнего изъятия из очереди.

При изъятии из очереди, время обновляется и элемент переносится в конец.

## Основная идея
Основная идея очереди построена на Redis hashmap, в котором хранятся полезные данные по идентификатору элементов, и 2-ух zset'ов, которые являются индексами элементов по времени их последнего изъятия из очереди (*lastDequeueIndex*) и времени их добавления в очередь (*createTimeIndex*).

### Порядок создания нового элемента в очереди
1. Добавляем элемент в hashmap
2. Добавляем элемент в zset *createTimeIndex*, в качестве *score* устанавливается таймштамп текущего времени.
3. Добавляем элемент в zset *lastDequeueIndex*, в качестве *score* устанавливается 0. Таким образом, мы повышаем его приоритет и ставим в начало очереди.

### Порядок изъятия элемента из очереди
1. Получаем элемент с наименьшим *score* из *lastDequeueIndex* с помощью команды `ZRANGE <zset_name> -inf +inf BYSCORE LIMIT 0 1 WITHSCORES`.
2. Смотрим на *score* элемента, если его значением больше текущего времени за вычетом *dequeuePeriod* (период, не чаще которого выдаем из очереди), то считаем, что на данный момент в очереди нет элементов, которые нужно отдавать. Таким образом, мы исключаем слишком частое изъятие из очереди одного и того же элемента.
3. Если элемент все-таки соответствует условию, мы обновляем его *score* текущим таймштампом. Таким образом, мы ставим элемент в самый конец zset'а.
4. Берем id элемента из zset и получаем его данные (*data*) из hashmap. После этого происходит возврат данных запросившему

### Порядок очистки очереди
1. При создании очереди запускается специальная горутина-клинер, которая периодически просыпается и очищает устаревшие элементы.
2. При срабатывании таймера, происходит запуск команды на *createTimeIndex*: `ZRANGE 1 <текущий timestamp - ttl> BYSCORE`. Таким образом, мы получаем отсортированный список идентификаторов, ttl которых уже истек
3. Полученные идентификаторы удаляются из hasmap и всех индексов.